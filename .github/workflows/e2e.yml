name: e2e

on:
  push:
    branches-ignore:
      - master
jobs:
  deploy-services:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Push required props to GITHUB_ENV
        run: |
          echo "PROFILE=stage" >> $GITHUB_ENV
          echo "PREFIX=dtuchs" >> $GITHUB_ENV

      - name: Check changes path
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            auth:
              - 'rococo-auth/**'
            api:
              - 'rococo-api/**'
            client:
              - 'rococo-client/**'             

      - name: Docker login
        run: |
          docker login --username ${{ vars.DOCKER_HUB_ACC }} --password "${{ secrets.DOCKER_HUB_PASSWORD }}"

      - name: build auth & deploy to stage
        if: steps.changes.outputs.auth == 'true'
        working-directory: ./
        run: |
          pwd
          gradle :rococo-auth:jib -x :rococo-e2e:test
          docker-compose pull auth.rococo.dc
          docker-compose stop auth.rococo.dc && docker-compose up -d --no-deps auth.rococo.dc
          docker system prune -a -f
          echo "Deploy auth to stage done!"

      - name: build api & deploy to stage
        if: steps.changes.outputs.api == 'true'
        working-directory: ./
        run: |
          pwd
          gradle :rococo-api:jib -x :rococo-e2e:test
          docker-compose pull api.rococo.dc
          docker-compose stop api.rococo.dc && docker-compose up -d --no-deps api.rococo.dc
          docker system prune -a -f
          echo "Deploy api to stage done!"

      - name: build frontend & deploy to stage
        if: steps.changes.outputs.client == 'true'
        working-directory: ./rococo-client
        run: |
          pwd
          docker build -t ${{ vars.DOCKER_HUB_ACC }}/rococo-client-${{ env.PROFILE }}:0.0.1-SNAPSHOT -t ${{ vars.DOCKER_HUB_ACC }}/rococo-client-${{ env.PROFILE }}:latest .
          docker push ${{ vars.DOCKER_HUB_ACC }}/rococo-client-${{ env.PROFILE }}:0.0.1-SNAPSHOT
          docker push ${{ vars.DOCKER_HUB_ACC }}/rococo-client-${{ env.PROFILE }}:latest
          cd ../ || exit 1
          docker-compose pull client.rococo.dc
          docker-compose stop client.rococo.dc && docker-compose up -d --no-deps client.rococo.dc
          docker system prune -a -f
          echo "Deploy frontend to stage done!"
